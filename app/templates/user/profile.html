{% extends "base.html" %}

{% block title %}Mi Perfil{% endblock %}

{% block body_class %}profile-page{% endblock %}

{% block content %}
<div class="profile-container">
  <h1>Perfil de {{ session.get('user_name') }}</h1>

  <div class="profile-section">
    <h2>Información personal</h2>
    <p><strong>Correo:</strong> {{ user.email }}</p>
    <p><strong>Rol:</strong> {{ user.role | capitalize }}</p>
  </div>

  <hr>

<div class="profile-section">
  <h2>Mis cursos</h2>

  {% if user.student_courses %}
    <ul class="courses-list">
      {% for sc in user.student_courses %}
        <li class="course-item">
          <strong>{{ sc.course.title }}</strong><br>
          Progreso: {{ sc.course.progress or 0 }}%<br>

          Certificado:
          {% set certificado = sc.course.certificados|selectattr("student_id", "equalto", user.id)|list %}
          {% if certificado %}
            <span class="certificado-ok">✔️ Obtenido</span>
          {% else %}
            ❌ No obtenido
          {% endif %}

          <br>
          Cuota vence: {{ sc.payment_due.strftime('%d/%m/%Y') if sc.payment_due else 'Sin fecha' }}<br>

          {% if sc.payment_due and sc.payment_due <= fecha_hoy %}
            <div class="alert alert-warning">
              ¡Tu cuota de <strong>{{ sc.course.title }}</strong> vence pronto!
            </div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No estás inscrito en ningún curso actualmente.</p>
    <a href="{{ url_for('user.shop') }}" class="btn btn-primary mt-2">
      <i class="fas fa-store"></i> Ver cursos disponibles
    </a>
      <div class="profile-section">
        <h2>Te pueden interesar</h2>
        {% for course in suggested_courses %}
          <div class="course-suggestion">
            <strong>{{ course.title }}</strong> - {{ course.category.name }}<br>
            <a href="{{ url_for('user.course_detail', course_id=course.id) }}" class="btn btn-sm">Ver curso</a>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <hr>

<div class="profile-section">
  <h2>Estado de pagos</h2>
  {% for student_course in user.student_courses %}
    <div class="payment-info">
      <strong>Curso:</strong> {{ student_course.course.title }}<br>
      <strong>Cuota vence:</strong>
      {{ student_course.payment_due.strftime('%d/%m/%Y') if student_course.payment_due else 'Sin fecha' }}<br>
      <strong>Estado de pago:</strong> {{ student_course.payment_status }}<br>
      <strong>Fecha de pago:</strong>
      {% if student_course.payment_date %}
        {{ student_course.payment_date.strftime('%d/%m/%Y') }}
      {% else %}
        No disponible
      {% endif %}
      <hr>
    </div>
  {% endfor %}
</div>

  <hr>

<div class="profile-section">
  <h2>Mensajes del tutor</h2>
  {% if user.received_messages %}
    <ul>
      {% for msg in user.received_messages %}
        <li>
          <strong>{{ msg.sender.full_name or msg.sender.username }}:</strong>
          {{ msg.body }}<br>
          <em>{{ msg.sent_at.strftime('%d/%m/%Y') }}</em>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No tenés mensajes nuevos.</p>
  {% endif %}
</div>
</div>

<a href="{{ url_for('user.shop') }}" class="floating-shop-btn">
  Comprar cursos
</a>
{% endblock %}
